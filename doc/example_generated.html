<!DOCTYPE html>
<html lang="en-GB">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <style>
      body {
        max-width: 38rem;
        margin: auto;
        padding: 1rem;
        font-family: system-ui;
        
        color: black;
        background-color: white;
        font-size:larger;
      }
      p {line-height: 1.4;}
      code {
      color:lightsteelblue;
      }
      footer {
      margin:0 auto;
      color:gray;
      display:table;
      }
      footer big {
      color:crimson;
      font-weight:bold;
      font-size:2rem;}
    </style>
    <title>calculator_controller.rb</title>
  </head>
  <body>
<h1>Calculating the scrutiny period</h1>
<pre><code>class CalculatorController &lt; ApplicationController
</code></pre>
<p>Set a title for the page people see.</p>
<pre><code>  def index
</code></pre>
<pre><code>    @title = &quot;Calculate scrutiny periods&quot;
</code></pre>
<pre><code>  end
</code></pre>
<p>In order to calculate the scrutiny period, we need:</p>
<pre><code>  def calculate
</code></pre>
<ul>
<li>the <strong>type of the procedure</strong> itself, which we refer to by a number</li>
</ul>
<pre><code>    procedure = params[&quot;procedure&quot;].to_i
</code></pre>
<ul>
<li>the <strong>start date</strong>, for example: &quot;2020-05-06&quot;</li>
</ul>
<pre><code>    start_date = params[&quot;start-date&quot;]
</code></pre>
<ul>
<li>the <strong>number of days</strong> to count</li>
</ul>
<pre><code>    @day_count = params[&quot;day-count&quot;].to_i
</code></pre>
<p>If the start date is in our calendar dates list ...</p>
<pre><code>    if CalendarDate.all.where( &#39;date = ?&#39;, start_date ).first
</code></pre>
<pre><code>      @start_date = CalendarDate.find_by_date( start_date )
</code></pre>
<p>... we can calculate the <strong>anticipated end date</strong> for a Proposed Statutory Instrument (PNSI):</p>
<pre><code>      if procedure == 1
</code></pre>
<p>PNSIs are always before both Houses, so we&#39;ll get ready to start counting the sitting days in each House.</p>
<pre><code>        commons_day_count = 0
</code></pre>
<pre><code>        lords_day_count = 0
</code></pre>
<p>We start counting on the <strong>first joint sitting day</strong> after the instrument is laid.</p>
<p>If we find the <strong>first joint sitting day</strong> following the start date, the laying date in this case, ...</p>
<pre><code>        if @start_date.first_joint_sitting_date
</code></pre>
<pre><code>          @date = @start_date.first_joint_sitting_date
</code></pre>
<p>... we look at each of our calendar dates, ensuring that we&#39;ve counted at least the set number of sitting days to count in each House. In the case of a PNSI, that&#39;s ten days.</p>
<pre><code>          while ( ( commons_day_count &lt;= @day_count ) and ( lords_day_count &lt;= @day_count ) ) do
</code></pre>
<p>If we have found a date that matches the criteria in the calendar, <strong>success!</strong></p>
<pre><code>            if @date.next_date
</code></pre>
<pre><code>              @date = @date.next_date
</code></pre>
<pre><code>            else
</code></pre>
<p>If we haven&#39;t found a date in the calendar, ...</p>
<pre><code>              @error_message = &quot;Ooops. We&#39;ve run out of calendar.&quot;
</code></pre>
<p>... <strong>we give up</strong>.</p>
<pre><code>              break
</code></pre>
<pre><code>            end
</code></pre>
<p>If the Lords sat on the date we&#39;ve found, we add another day to the count.</p>
<pre><code>            lords_day_count +=1 if @date.is_lords_sitting_day?
</code></pre>
<p>If the Commons sat on the date we&#39;ve found, we add another day to the count.</p>
<pre><code>            commons_day_count+=1 if @date.is_commons_sitting_day?
</code></pre>
<pre><code>          end
</code></pre>
<p>If we didn&#39;t find any <strong>future joint sitting date</strong> in our calendar, we can&#39;t calculate the scrutiny period - and we show an error message.</p>
<pre><code>        else
</code></pre>
<pre><code>          @error_message = &quot;Ooops. We&#39;ve run out of calendar.&quot;
</code></pre>
<pre><code>        end
</code></pre>
<pre><code>      end
</code></pre>
<p>If the <strong>start date</strong> isn&#39;t in our calendar dates list, we can&#39;t calculate the scrutiny period - and we show an error message.</p>
<pre><code>    else
</code></pre>
<pre><code>      @error_message = &quot;Ooops. We&#39;ve run out of calendar.&quot;
</code></pre>
<pre><code>    end
</code></pre>
<pre><code>  end
</code></pre>
<pre><code>end
</code></pre>
<footer><p><big>&times;&times;&times;</big></p></footer></body></html>

